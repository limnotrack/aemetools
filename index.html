<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="Run simple hydrological models to generate inflow inputs for the
    AEME package, download ERA5-Land data for any point in New Zealand, and
    calibrate the AEME model ensemble.">
<title>aemetools - Improve ecosystem modelling â€¢ aemetools</title>
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="aemetools - Improve ecosystem modelling">
<meta property="og:description" content="Run simple hydrological models to generate inflow inputs for the
    AEME package, download ERA5-Land data for any point in New Zealand, and
    calibrate the AEME model ensemble.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="index.html">aemetools</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="articles/calibrate-aeme.html">Calibrate AEME</a>
    <a class="dropdown-item" href="articles/download-era5.html">Download ERA5 data</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9"><div class="section level1">
<div class="page-header"><h1 id="aemetools">aemetools<a class="anchor" aria-label="anchor" href="#aemetools"></a>
</h1></div>
<!-- badges: start -->

<p>aemetools is designed to work with <a href="https://github.com/limnotrack/AEME/" class="external-link">AEME</a>. It contains a range of functions to assist in setting up simulations for a new lake site.</p>
<p>Currently, you can use this to download meteorological data from <a href="https://www.ecmwf.int/en/era5-land" class="external-link">ERA5-Land</a> for any point in New Zealand from 1999-2022, or download ERA5-Land netCDF files for any area in the world. It can set up and run hydrological simulations using the suite of models from the <a href="https://hydrogr.github.io/airGR/" class="external-link"><code>airGR</code></a> package using catchment, reach and lake data.</p>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>You can install the development version of aemetools from <a href="https://github.com/" class="external-link">GitHub</a> with:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install.packages("devtools")</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"limnotrack/aemetools"</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="download-nz-point-meteorological-data">Download NZ point meteorological data<a class="anchor" aria-label="anchor" href="#download-nz-point-meteorological-data"></a>
</h3>
<p>Currently, there is ERA5-Land data (~9km grid spacing) archived for New Zealand (166.5/-46.6/178.6/-34.5) for the time period 1999-2022 with the main meteorological variables (air temperature, dewpoint temperature, wind u-vector at 10m, wind v-vector at 10m, total precipitation, snowfall, surface level pressure, downwelling shortwave radiation, downwelling longwave radiation) required to drive hydrological and hydrodynamic models. This can be easily downloaded using the example below. There is a <code>parallel</code> switch which allows you to use multiple cores on your computer to speed up the download.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://studious-enigma-z736ppg.pages.github.io/" class="external-link">aemetools</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">lon</span> <span class="op">&lt;-</span> <span class="fl">176.2717</span></span>
<span><span class="va">lat</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">38.079</span></span>
<span><span class="va">variables</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"MET_tmpair"</span>, <span class="st">"MET_pprain"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">met</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/get_era5_point.html">get_era5_point</a></span><span class="op">(</span>lat <span class="op">=</span> <span class="va">lat</span>, lon <span class="op">=</span> <span class="va">lon</span>, years <span class="op">=</span> <span class="fl">2000</span><span class="op">:</span><span class="fl">2001</span>,</span>
<span>                      variables <span class="op">=</span> <span class="va">variables</span>, format <span class="op">=</span> <span class="st">"aeme"</span>, parallel <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Auto-refreshing stale OAuth token.</span></span>
<span><span class="co">#&gt; Downloading ERA5 variables in parallel... [2023-11-08 15:28:05.108454]</span></span>
<span><span class="co">#&gt; Finished downloading ERA5 variables! [2023-11-08 15:28:25.315201]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">met</span><span class="op">)</span></span>
<span><span class="co">#&gt;       Date              MET_tmpair       MET_pprain     </span></span>
<span><span class="co">#&gt;  Min.   :2000-01-01   Min.   : 3.407   Min.   : 0.0000  </span></span>
<span><span class="co">#&gt;  1st Qu.:2000-07-01   1st Qu.: 9.129   1st Qu.: 0.2188  </span></span>
<span><span class="co">#&gt;  Median :2000-12-30   Median :12.032   Median : 2.0354  </span></span>
<span><span class="co">#&gt;  Mean   :2000-12-30   Mean   :11.957   Mean   : 6.7384  </span></span>
<span><span class="co">#&gt;  3rd Qu.:2001-06-30   3rd Qu.:14.815   3rd Qu.: 8.3548  </span></span>
<span><span class="co">#&gt;  Max.   :2001-12-30   Max.   :19.970   Max.   :86.6961</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="run-gr4j-model">Run GR4J model<a class="anchor" aria-label="anchor" href="#run-gr4j-model"></a>
</h3>
<p>Here is simple example set up for one of the lake inflows into Lake Rotorua. First, the input for the model are generated using the stream ID (nzsegment), and spatial features (sf objects) of the reaches, lake and catchment (including sub-catchments), observed discharge (if available) meteorological data (air temperature and precipitation). It recursively creates an upstream network using the nzsegment, then combines the subcatchments of all the upstream reaches (<code><a href="https://r-spatial.github.io/sf/reference/geos_combine.html" class="external-link">sf::st_union()</a></code>) to calculate the area of the catchment.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/hydro/"</span>, package <span class="op">=</span> <span class="st">"aemetools"</span><span class="op">)</span></span>
<span><span class="va">lake</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">data_dir</span>, <span class="st">"lake.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">reaches</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">data_dir</span>, <span class="st">"reaches.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">catchments</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">data_dir</span>, <span class="st">"catchments.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">met</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">data_dir</span>, <span class="st">"met.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">obs_flow</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">data_dir</span>, <span class="st">"obs_flow.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">FUN_MOD</span> <span class="op">&lt;-</span> <span class="fu">airGR</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/airGR/man/RunModel_GR4J.html" class="external-link">RunModel_GR4J</a></span></span>
<span><span class="va">id</span> <span class="op">&lt;-</span> <span class="fl">4087861</span> <span class="co"># nzsegment</span></span>
<span></span>
<span><span class="va">inputs</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/make_GR_inputs.html">make_GR_inputs</a></span><span class="op">(</span>id <span class="op">=</span> <span class="va">id</span>, reaches <span class="op">=</span> <span class="va">reaches</span>, lake <span class="op">=</span> <span class="va">lake</span>,</span>
<span>                         catchments <span class="op">=</span> <span class="va">catchments</span>, obs_flow <span class="op">=</span> <span class="va">obs_flow</span>, met <span class="op">=</span> <span class="va">met</span>,</span>
<span>                         lat <span class="op">=</span> <span class="va">lat</span>, FUN_MOD <span class="op">=</span> <span class="va">FUN_MOD</span>,</span>
<span>                         plot <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: attribute variables are assumed to be spatially constant throughout</span></span>
<span><span class="co">#&gt; all geometries</span></span>
<span><span class="co">#&gt; Warning in make_GR_inputs(id = id, reaches = reaches, lake = lake, catchments =</span></span>
<span><span class="co">#&gt; catchments, : NA values present. Selecting period with less NA's.</span></span></code></pre></div>
<p><img src="reference/figures/README-make-gr4j-inputs-1.png" width="100%"></p>
<p>Within the <code>airGR</code> package, there are calibration algorithms which allows you to calibrate the hydrological model if discharge data for the reach is available. The calibrated parameters can be passed to the <code>run_GR</code> function to run the selected model.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' airGR uses indices to run the model, so first we split our observed data in </span></span>
<span><span class="co">#' half (0.5) for calibration and validation periods based on when the </span></span>
<span><span class="co">#' observation data starts (which is provided in `inputs$data$start`).</span></span>
<span><span class="va">idx_spl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">inputs</span><span class="op">$</span><span class="va">data</span><span class="op">[</span><span class="va">inputs</span><span class="op">$</span><span class="va">start</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">inputs</span><span class="op">$</span><span class="va">data</span><span class="op">)</span>, <span class="op">]</span><span class="op">)</span></span>
<span>                 <span class="op">*</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="co">#' Use a model warmup period as everything before when the observations start.</span></span>
<span><span class="va">warmup</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">inputs</span><span class="op">$</span><span class="va">start</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set the indices for the calibration period</span></span>
<span><span class="va">cal_idx</span> <span class="op">&lt;-</span> <span class="va">inputs</span><span class="op">$</span><span class="va">start</span><span class="op">:</span><span class="op">(</span><span class="va">idx_spl</span> <span class="op">+</span> <span class="va">inputs</span><span class="op">$</span><span class="va">start</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run the calibration and assign the output</span></span>
<span><span class="va">calib</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/calib_GR.html">calib_GR</a></span><span class="op">(</span>inputs <span class="op">=</span> <span class="va">inputs</span>, warmup <span class="op">=</span> <span class="va">warmup</span>, run_index <span class="op">=</span> <span class="va">cal_idx</span><span class="op">)</span></span>
<span><span class="co">#&gt; Grid-Screening in progress (0% 20% 40% 60% 80% 100%)</span></span>
<span><span class="co">#&gt;   Screening completed (81 runs)</span></span>
<span><span class="co">#&gt;       Param =  432.681,   -2.376,   83.096,    2.384</span></span>
<span><span class="co">#&gt;       Crit. NSE[Q]       = -12.8326</span></span>
<span><span class="co">#&gt; Steepest-descent local search in progress</span></span>
<span><span class="co">#&gt;   Calibration completed (30 iterations, 289 runs)</span></span>
<span><span class="co">#&gt;       Param = 21807.299,   -9.151,  104.585,    2.003</span></span>
<span><span class="co">#&gt;       Crit. NSE[Q]       = 0.4836</span></span>
<span></span>
<span><span class="co"># Extract the calibrated parameters</span></span>
<span><span class="va">param</span> <span class="op">&lt;-</span> <span class="va">calib</span><span class="op">$</span><span class="va">ParamFinalR</span></span>
<span></span>
<span><span class="co"># Run the model</span></span>
<span><span class="va">output</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/run_GR.html">run_GR</a></span><span class="op">(</span>inputs <span class="op">=</span> <span class="va">inputs</span>, param <span class="op">=</span> <span class="va">param</span>,</span>
<span>                 warmup <span class="op">=</span> <span class="va">warmup</span>, run_index <span class="op">=</span> <span class="va">cal_idx</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot the output</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">output</span>, Qobs <span class="op">=</span> <span class="va">inputs</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">Qmm</span><span class="op">[</span><span class="va">cal_idx</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-run-gr4j-1.png" width="100%"></p>
</div>
</div>
</div>
  </main><aside class="col-md-3"><div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small>GPL (&gt;= 2)</small></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing aemetools</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Tadhg Moore <br><small class="roles"> Author, maintainer </small>  </li>
<li>Chris McBride <br><small class="roles"> Author </small>  </li>
</ul>
</div>

<div class="dev-status">
<h2 data-toc-skip>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://lifecycle.r-lib.org/articles/stages.html#experimental" class="external-link"><img src="https://img.shields.io/badge/lifecycle-experimental-orange.svg" alt="Lifecycle: experimental"></a></li>
<li><a href="https://github.com/limnotrack/aemetools/actions/workflows/R-CMD-check.yaml" class="external-link"><img src="https://github.com/limnotrack/aemetools/actions/workflows/R-CMD-check.yaml/badge.svg" alt="R-CMD-check"></a></li>
<li><a href="https://app.codecov.io/gh/limnotrack/aemetools?branch=main" class="external-link"><img src="https://codecov.io/gh/limnotrack/aemetools/branch/main/graph/badge.svg" alt="Codecov test coverage"></a></li>
</ul>
</div>

<div class="table-of-contents">
<h2 data-toc-skip>Table of contents</h2>
<ul class="list-unstyled">
<li><nav id="toc"></nav></li>
</ul>
</div>

  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Tadhg Moore, Chris McBride.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
