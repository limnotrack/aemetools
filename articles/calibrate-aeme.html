<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="aemetools">
<title>Calibrate AEME â€¢ aemetools</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Calibrate AEME">
<meta property="og:description" content="aemetools">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">aemetools</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/calibrate-aeme.html">Calibrate AEME</a>
    <a class="dropdown-item" href="../articles/download-era5.html">Download ERA5 data</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Calibrate AEME</h1>
            
      
      
      <div class="d-none name"><code>calibrate-aeme.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<p>First, we will load the <code>AEME</code> and <code>aemetools</code>
package:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://expert-guide-29ve1vw.pages.github.io/" class="external-link">AEME</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://studious-enigma-z736ppg.pages.github.io/" class="external-link">aemetools</a></span><span class="op">)</span></span></code></pre></div>
<p>Create a folder for running the example calibration setup.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">tmpdir</span> <span class="op">&lt;-</span> <span class="st">"calib-test"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">tmpdir</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">aeme_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/lake/"</span>, package <span class="op">=</span> <span class="st">"AEME"</span><span class="op">)</span></span>
<span><span class="co"># Copy files from package into tempdir</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.copy</a></span><span class="op">(</span><span class="va">aeme_dir</span>, <span class="va">tmpdir</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="va">path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">tmpdir</span>, <span class="st">"lake"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">path</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "aeme.yaml"            "data/catchment.dbf"   "data/catchment.prj"  </span></span>
<span><span class="co">#&gt;  [4] "data/catchment.shp"   "data/catchment.shx"   "data/hypsograph.csv" </span></span>
<span><span class="co">#&gt;  [7] "data/inflow_FWMT.csv" "data/lake.dbf"        "data/lake.prj"       </span></span>
<span><span class="co">#&gt; [10] "data/lake.shp"        "data/lake.shx"        "data/lake_obs.csv"   </span></span>
<span><span class="co">#&gt; [13] "data/meteo.csv"       "data/outflow.csv"     "data/water_level.csv"</span></span>
<span><span class="co">#&gt; [16] "model_controls.csv"</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="build-aeme-ensemble">Build AEME ensemble<a class="anchor" aria-label="anchor" href="#build-aeme-ensemble"></a>
</h2>
<p>Using the <code>AEME</code> functions, we will build the AEME model
setup. For this example, we will use the <code>glm_aed</code> model. The
<code>build_ensemble</code> function will</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">aeme_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/AEME/man/yaml_to_aeme.html" class="external-link">yaml_to_aeme</a></span><span class="op">(</span>path <span class="op">=</span> <span class="va">path</span>, <span class="st">"aeme.yaml"</span><span class="op">)</span></span>
<span><span class="va">mod_ctrls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">path</span>, <span class="st">"model_controls.csv"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">inf_factor</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"dy_cd"</span> <span class="op">=</span> <span class="fl">1</span>, <span class="st">"glm_aed"</span> <span class="op">=</span> <span class="fl">1</span>, <span class="st">"gotm_wet"</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">outf_factor</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"dy_cd"</span> <span class="op">=</span> <span class="fl">1</span>, <span class="st">"glm_aed"</span> <span class="op">=</span> <span class="fl">1</span>, <span class="st">"gotm_wet"</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"glm_aed"</span><span class="op">)</span></span>
<span><span class="va">aeme_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/AEME/man/build_ensemble.html" class="external-link">build_ensemble</a></span><span class="op">(</span>path <span class="op">=</span> <span class="va">path</span>, aeme_data <span class="op">=</span> <span class="va">aeme_data</span>,</span>
<span>                            model <span class="op">=</span> <span class="va">model</span>, mod_ctrls <span class="op">=</span> <span class="va">mod_ctrls</span>,</span>
<span>                            inf_factor <span class="op">=</span> <span class="va">inf_factor</span>, ext_elev <span class="op">=</span> <span class="fl">5</span>,</span>
<span>                            use_bgc <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>Run the model ensemble using the <code>run_aeme</code> function to
make sure the current model setup is working.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aeme_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/AEME/man/run_aeme.html" class="external-link">run_aeme</a></span><span class="op">(</span>aeme_data <span class="op">=</span> <span class="va">aeme_data</span>, model <span class="op">=</span> <span class="va">model</span>,</span>
<span>                      verbose <span class="op">=</span> <span class="cn">FALSE</span>, mod_ctrls <span class="op">=</span> <span class="va">mod_ctrls</span>,</span>
<span>                      path <span class="op">=</span> <span class="va">path</span><span class="op">)</span></span>
<span><span class="co">#&gt; Running models... (Have you tried parallelizing?) [2024-01-08 02:20:13]</span></span>
<span><span class="co">#&gt; GLM-AED run successful! [2024-01-08 02:20:14]</span></span>
<span><span class="co">#&gt; Model run complete![2024-01-08 02:20:14]</span></span>
<span><span class="co">#&gt; Retrieving and formatting temp for model glm_aed</span></span>
<span><span class="co">#&gt; Retrieving and formatting salt for model glm_aed</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">aeme_data</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="calibrate-aeme_files/figure-html/run-aeme-example-1.png" alt="Simple plots of surface and bottom water temperarure an lake level after running AEME with the glm_aed model." width="768"><p class="caption">
Simple plots of surface and bottom water temperarure an lake level after
running AEME with the glm_aed model.
</p>
</div>
</div>
<div class="section level2">
<h2 id="load-parameters-to-be-used-for-the-calibration">Load parameters to be used for the calibration<a class="anchor" aria-label="anchor" href="#load-parameters-to-be-used-for-the-calibration"></a>
</h2>
<p>Parameters are loaded from the <code>aemetools</code> package within
the <code>aeme_parameters</code> dataframe. The parameters are stored in
a data frame with the following columns:</p>
<ul>
<li><p><code>model</code>: The model name</p></li>
<li><p><code>file</code>: The file name of the model parameter
file</p></li>
<li><p><code>name</code>: The parameter name</p></li>
<li><p><code>value</code>: The parameter value</p></li>
<li><p><code>min</code>: The minimum value of the parameter</p></li>
<li><p><code>max</code>: The maximum value of the parameter</p></li>
</ul>
<p>Parameters to be used for the calibration. (man)</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"aeme_parameters"</span>, package <span class="op">=</span> <span class="st">"aemetools"</span><span class="op">)</span></span>
<span><span class="va">aeme_parameters</span></span>
<span><span class="co">#&gt;       model          file                               name       value   min</span></span>
<span><span class="co">#&gt; 1   glm_aed      glm3.nml                           light/Kw 5.81166e-01 1e-01</span></span>
<span><span class="co">#&gt; 2   glm_aed           met                         MET_wndspd 1.14374e+00 7e-01</span></span>
<span><span class="co">#&gt; 3   glm_aed           met                         MET_radswd 9.66115e-01 7e-01</span></span>
<span><span class="co">#&gt; 4   glm_aed           wdr                            outflow 1.00000e+00 5e-01</span></span>
<span><span class="co">#&gt; 5  gotm_wet     gotm.yaml        turbulence/turb_param/k_min 6.32000e-07 1e-09</span></span>
<span><span class="co">#&gt; 6  gotm_wet     gotm.yaml light_extinction/g2/constant_value 2.00000e-01 5e-02</span></span>
<span><span class="co">#&gt; 7  gotm_wet           met                         MET_wndspd 1.06917e+00 7e-01</span></span>
<span><span class="co">#&gt; 8  gotm_wet           met                         MET_radswd 1.17340e+00 7e-01</span></span>
<span><span class="co">#&gt; 9  gotm_wet           wdr                            outflow 1.00000e+00 5e-01</span></span>
<span><span class="co">#&gt; 10    dy_cd           cfg     light_extinction_coefficient/7 9.00000e-01 1e-01</span></span>
<span><span class="co">#&gt; 11    dy_cd dyresm3p1.par           vertical_mixing_coeff/15 2.00000e+02 5e+01</span></span>
<span><span class="co">#&gt; 12    dy_cd           met                         MET_wndspd 1.00000e+00 7e-01</span></span>
<span><span class="co">#&gt; 13    dy_cd           met                         MET_radswd 1.00000e+00 7e-01</span></span>
<span><span class="co">#&gt; 14    dy_cd           wdr                            outflow 1.00000e+00 5e-01</span></span>
<span><span class="co">#&gt;         max</span></span>
<span><span class="co">#&gt; 1  5.52e+00</span></span>
<span><span class="co">#&gt; 2  1.30e+00</span></span>
<span><span class="co">#&gt; 3  1.30e+00</span></span>
<span><span class="co">#&gt; 4  2.50e+00</span></span>
<span><span class="co">#&gt; 5  1.00e-05</span></span>
<span><span class="co">#&gt; 6  2.70e+00</span></span>
<span><span class="co">#&gt; 7  1.30e+00</span></span>
<span><span class="co">#&gt; 8  1.30e+00</span></span>
<span><span class="co">#&gt; 9  2.50e+00</span></span>
<span><span class="co">#&gt; 10 1.40e+00</span></span>
<span><span class="co">#&gt; 11 7.50e+02</span></span>
<span><span class="co">#&gt; 12 1.30e+00</span></span>
<span><span class="co">#&gt; 13 1.30e+00</span></span>
<span><span class="co">#&gt; 14 2.50e+00</span></span></code></pre></div>
<p>This dataframe can be modified to change the parameter values. For
example, we can change the <code>light/Kw</code> parameter for the
<code>glm_aed</code> model to 0.1:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aeme_parameters</span><span class="op">[</span><span class="va">aeme_parameters</span><span class="op">$</span><span class="va">model</span> <span class="op">==</span> <span class="st">"glm_aed"</span> <span class="op">&amp;</span></span>
<span>                  <span class="va">aeme_parameters</span><span class="op">$</span><span class="va">name</span> <span class="op">==</span> <span class="st">"light/Kw"</span>, <span class="st">"value"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.1</span></span>
<span><span class="va">aeme_parameters</span></span>
<span><span class="co">#&gt;       model          file                               name       value   min</span></span>
<span><span class="co">#&gt; 1   glm_aed      glm3.nml                           light/Kw 1.00000e-01 1e-01</span></span>
<span><span class="co">#&gt; 2   glm_aed           met                         MET_wndspd 1.14374e+00 7e-01</span></span>
<span><span class="co">#&gt; 3   glm_aed           met                         MET_radswd 9.66115e-01 7e-01</span></span>
<span><span class="co">#&gt; 4   glm_aed           wdr                            outflow 1.00000e+00 5e-01</span></span>
<span><span class="co">#&gt; 5  gotm_wet     gotm.yaml        turbulence/turb_param/k_min 6.32000e-07 1e-09</span></span>
<span><span class="co">#&gt; 6  gotm_wet     gotm.yaml light_extinction/g2/constant_value 2.00000e-01 5e-02</span></span>
<span><span class="co">#&gt; 7  gotm_wet           met                         MET_wndspd 1.06917e+00 7e-01</span></span>
<span><span class="co">#&gt; 8  gotm_wet           met                         MET_radswd 1.17340e+00 7e-01</span></span>
<span><span class="co">#&gt; 9  gotm_wet           wdr                            outflow 1.00000e+00 5e-01</span></span>
<span><span class="co">#&gt; 10    dy_cd           cfg     light_extinction_coefficient/7 9.00000e-01 1e-01</span></span>
<span><span class="co">#&gt; 11    dy_cd dyresm3p1.par           vertical_mixing_coeff/15 2.00000e+02 5e+01</span></span>
<span><span class="co">#&gt; 12    dy_cd           met                         MET_wndspd 1.00000e+00 7e-01</span></span>
<span><span class="co">#&gt; 13    dy_cd           met                         MET_radswd 1.00000e+00 7e-01</span></span>
<span><span class="co">#&gt; 14    dy_cd           wdr                            outflow 1.00000e+00 5e-01</span></span>
<span><span class="co">#&gt;         max</span></span>
<span><span class="co">#&gt; 1  5.52e+00</span></span>
<span><span class="co">#&gt; 2  1.30e+00</span></span>
<span><span class="co">#&gt; 3  1.30e+00</span></span>
<span><span class="co">#&gt; 4  2.50e+00</span></span>
<span><span class="co">#&gt; 5  1.00e-05</span></span>
<span><span class="co">#&gt; 6  2.70e+00</span></span>
<span><span class="co">#&gt; 7  1.30e+00</span></span>
<span><span class="co">#&gt; 8  1.30e+00</span></span>
<span><span class="co">#&gt; 9  2.50e+00</span></span>
<span><span class="co">#&gt; 10 1.40e+00</span></span>
<span><span class="co">#&gt; 11 7.50e+02</span></span>
<span><span class="co">#&gt; 12 1.30e+00</span></span>
<span><span class="co">#&gt; 13 1.30e+00</span></span>
<span><span class="co">#&gt; 14 2.50e+00</span></span></code></pre></div>
<p>This dataframe can be passed to the <code>run_aeme_param</code>
function to run AEME with the parameter values specified in the
dataframe. This function is different to the <code>run_aeme</code>
function in that it does not return an <code>aeme_data</code> object,
but the model output is generate within the lake folder.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/run_aeme_param.html">run_aeme_param</a></span><span class="op">(</span>aeme_data <span class="op">=</span> <span class="va">aeme_data</span>, param <span class="op">=</span> <span class="va">aeme_parameters</span>,</span>
<span>                 model <span class="op">=</span> <span class="va">model</span>, path <span class="op">=</span> <span class="va">path</span>, mod_ctrls <span class="op">=</span> <span class="va">mod_ctrls</span><span class="op">)</span></span>
<span><span class="co">#&gt; Running models... (Have you tried parallelizing?) [2024-01-08 02:20:26]</span></span>
<span><span class="co">#&gt; GLM-AED run successful! [2024-01-08 02:20:27]</span></span>
<span><span class="co">#&gt; Model run complete![2024-01-08 02:20:27]</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="calibration-setup">Calibration setup<a class="anchor" aria-label="anchor" href="#calibration-setup"></a>
</h2>
<div class="section level3">
<h3 id="define-fitness-function">Define fitness function<a class="anchor" aria-label="anchor" href="#define-fitness-function"></a>
</h3>
<p>First, we will define a function for the calibration function to use
to calculate the fitness of the model. This function takes a dataframe
as an argument. The dataframe contains the observed data
(<code>obs</code>) and the modelled data (<code>model</code>). The
function should return a single value.</p>
<p>Here we use the root mean square error (RMSE) as the fitness
function:</p>
<p><span class="math display">\[\text{RMSE}(y, \hat{y}) =
\sqrt{\frac{\sum_{i=0}^{N - 1} (y_i - \hat{y}_i)^2}{N}}\]</span></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Function to calculate fitness</span></span>
<span><span class="va">rmse</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">obs</span> <span class="op">-</span> <span class="va">df</span><span class="op">$</span><span class="va">model</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Different functions can be applied to different variables. For
example, we can use the RMSE for the lake level and the mean absolute
error (MAE) for the water temperature:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Function to calculate fitness</span></span>
<span><span class="va">mae</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">obs</span> <span class="op">-</span> <span class="va">df</span><span class="op">$</span><span class="va">model</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Then these would be combined into a named list of functions which
will be passed to the <code>calib_aeme</code> function.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Create list of functions</span></span>
<span><span class="va">FUN_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>HYD_temp <span class="op">=</span> <span class="va">mae</span>, LKE_lvlwtr <span class="op">=</span> <span class="va">rmse</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="define-control-parameters">Define control parameters<a class="anchor" aria-label="anchor" href="#define-control-parameters"></a>
</h3>
<p>Next, we will define the control parameters for the calibration. The
control parameters are passed to the <code>calib_aeme</code> function.
The control parameters are as follows:</p>
<ul>
<li>
<code>VTR</code>: The value to reach. The calibration will stop when
the fitness value is less than or equal to this value. For this
example</li>
<li>
<code>NP</code>: The number of individuals in the population. Best
practice is to use 10 times the number of parameters.</li>
<li>
<code>itermax</code>: The maximum number of iterations to run the
calibration for. The calibration will stop when this number of
iterations is reached. The number of generations used is equal to
<code>itermax / NP</code>. Therefore, through adjusting <code>NP</code>
and <code>itermax</code> the number of generations can be adjusted.</li>
<li>
<code>reltol</code>: The relative tolerance for the calibration. The
calibration will stop when the relative change in the fitness value is
less than this value.</li>
<li>
<code>p</code>: The quantile used to select the parents for the next
generation. For example, if <code>p = 0.25</code>, the best 25% of the
population will be used as parents for the next generation.</li>
<li>
<code>mutate</code>: The mutation rate for the calibration. This is
the probability of a parameter being mutated.</li>
<li>
<code>parallel</code>: Whether to run the calibration in parallel.
This will decrease the time taken to run the calibration.</li>
<li>
<code>out_file</code>: The file to write the calibration results
to.</li>
<li>
<code>na_value</code>: The value to use for missing values in the
observed and predicted data. This is used to indicate when the model
crashes and then can be easily removed from the calibration
results.</li>
<li>
<code>ncore</code>: The number of cores to use for the calibration.
This is only used if <code>parallel = TRUE</code>.</li>
</ul>
<p>Here is an example of the control parameters:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ctrl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>VTR <span class="op">=</span> <span class="fl">1</span>, NP <span class="op">=</span> <span class="fl">40</span>, itermax <span class="op">=</span> <span class="fl">400</span>, reltol <span class="op">=</span> <span class="fl">0.07</span>, cutoff <span class="op">=</span> <span class="fl">0.25</span>,</span>
<span>             mutate <span class="op">=</span> <span class="fl">0.1</span>, parallel <span class="op">=</span> <span class="cn">TRUE</span>, out_file <span class="op">=</span> <span class="st">"results.csv"</span>,</span>
<span>             na_value <span class="op">=</span> <span class="fl">999</span>, ncore <span class="op">=</span> <span class="fl">2L</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="define-variables">Define variables<a class="anchor" aria-label="anchor" href="#define-variables"></a>
</h3>
<p>Next we will select the variables to use for the calibration. The
variables selected need to use the AEME variable definition e.g.
<code>c("HYD_temp", "LKE_lvlwtr")</code>. Weights need to be attributed
to each of the variables. The weights are used to scale the fitness
value. This can be helpful if the variables have different units. For
example, if the temperature is in degrees Celsius and the water level is
in metres, then the water level will have a much larger impact on the
fitness value. Therefore, the weight for the water level should be much
smaller than the weight for the temperature.</p>
<p>The weights are specified in a named vector. The names of the vector
should be the same as the variable names.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vars_sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"HYD_temp"</span><span class="op">)</span></span>
<span><span class="va">weights</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"HYD_temp"</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="run-calibration">Run calibration<a class="anchor" aria-label="anchor" href="#run-calibration"></a>
</h2>
<p>Once we have defined the fitness function, control parameters and
variables, we can run the calibration. The <code>calib_aeme</code>
function takes the following arguments:</p>
<ul>
<li>
<code>aeme_data</code>: The <code>aeme_data</code> object to use for
the calibration.</li>
<li>
<code>path</code>: The path to the lake folder.</li>
<li>
<code>param</code>: The parameters to calibrate.</li>
<li>
<code>model</code>: The model to calibrate.</li>
<li>
<code>mod_ctrls</code>: The model controls to use for the
calibration.</li>
<li>
<code>FUN_list</code>: The list of functions to use for each
variable within the calibration.</li>
<li>
<code>ctrl</code>: The control parameters to use for the
calibration.</li>
<li>
<code>vars_sim</code>: The variables to use for the
calibration.</li>
<li>
<code>weights</code>: The weights to use for the calibration.</li>
</ul>
<p>The <code>calib_aeme</code> function writes the calibration results
to the file specified after each generation. This allows the calibration
to be stopped and restarted at any time. The <code>calib_aeme</code>
function returns the <code>ctrl</code> object with any updated
values.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ctrl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calib_aeme.html">calib_aeme</a></span><span class="op">(</span>aeme_data <span class="op">=</span> <span class="va">aeme_data</span>, path <span class="op">=</span> <span class="va">path</span>,</span>
<span>                   param <span class="op">=</span> <span class="va">aeme_parameters</span>, model <span class="op">=</span> <span class="va">model</span>,</span>
<span>                   mod_ctrls <span class="op">=</span> <span class="va">mod_ctrls</span>, FUN_list <span class="op">=</span> <span class="va">FUN_list</span>, ctrl <span class="op">=</span> <span class="va">ctrl</span>,</span>
<span>                   vars_sim <span class="op">=</span> <span class="va">vars_sim</span>, weights <span class="op">=</span> <span class="va">weights</span><span class="op">)</span></span>
<span><span class="co">#&gt; Extracting indices for modelled variables [2024-01-08 02:20:27]</span></span>
<span><span class="co">#&gt; Complete! [2024-01-08 02:20:28]</span></span>
<span><span class="co">#&gt; Calibrating in parallel using 1 cores...</span></span>
<span><span class="co">#&gt; Starting generation 1/10, 40 members. [2024-01-08 02:20:28]</span></span>
<span><span class="co">#&gt;        light.Kw MET_wndspd MET_radswd outflow</span></span>
<span><span class="co">#&gt; mean      2.816     1.0000     0.9995  1.5020</span></span>
<span><span class="co">#&gt; median    2.829     1.0040     0.9986  1.5000</span></span>
<span><span class="co">#&gt; sd        1.588     0.1746     0.1759  0.5872</span></span>
<span><span class="co">#&gt; Best fit: 2.16 (sd: 222.003)</span></span>
<span><span class="co">#&gt;             Parameters: [3.715, 0.993, 1.249, 0.955]</span></span>
<span><span class="co">#&gt; Survival rate: 1</span></span>
<span><span class="co">#&gt; Starting generation 2/10, 40 members. [2024-01-08 02:21:03]</span></span>
<span><span class="co">#&gt;        light.Kw MET_wndspd MET_radswd outflow</span></span>
<span><span class="co">#&gt; mean      2.974     1.0630    1.14500  0.9813</span></span>
<span><span class="co">#&gt; median    2.908     1.0860    1.16100  0.9149</span></span>
<span><span class="co">#&gt; sd        1.880     0.1495    0.08808  0.4569</span></span>
<span><span class="co">#&gt; Best fit: 2.1403 (sd: 138.01)</span></span>
<span><span class="co">#&gt; Survival rate: 1</span></span>
<span><span class="co">#&gt; Starting generation 3/10, 40 members. [2024-01-08 02:21:38]</span></span>
<span><span class="co">#&gt;        light.Kw MET_wndspd MET_radswd outflow</span></span>
<span><span class="co">#&gt; mean      3.511     1.0050    1.16500  0.8872</span></span>
<span><span class="co">#&gt; median    3.289     1.0080    1.18600  0.8108</span></span>
<span><span class="co">#&gt; sd        1.163     0.1469    0.09507  0.3310</span></span>
<span><span class="co">#&gt; Best fit: 2.1403 (sd: 106.19)</span></span>
<span><span class="co">#&gt; Survival rate: 1</span></span>
<span><span class="co">#&gt; Starting generation 4/10, 40 members. [2024-01-08 02:22:13]</span></span>
<span><span class="co">#&gt;        light.Kw MET_wndspd MET_radswd outflow</span></span>
<span><span class="co">#&gt; mean      3.146     0.9300     1.1800  0.8561</span></span>
<span><span class="co">#&gt; median    3.211     0.9046     1.2100  0.7568</span></span>
<span><span class="co">#&gt; sd        1.215     0.1695     0.1191  0.3914</span></span>
<span><span class="co">#&gt; Best fit: 2.1403 (sd: 129.29)</span></span>
<span><span class="co">#&gt; Survival rate: 1</span></span>
<span><span class="co">#&gt; Starting generation 5/10, 40 members. [2024-01-08 02:22:47]</span></span>
<span><span class="co">#&gt;        light.Kw MET_wndspd MET_radswd outflow</span></span>
<span><span class="co">#&gt; mean      2.918     0.8769      1.197  0.7257</span></span>
<span><span class="co">#&gt; median    2.741     0.8546      1.204  0.6308</span></span>
<span><span class="co">#&gt; sd        1.197     0.1443      0.043  0.3572</span></span>
<span><span class="co">#&gt; Best fit: 2.1403 (sd: 95.102)</span></span>
<span><span class="co">#&gt; Survival rate: 1</span></span>
<span><span class="co">#&gt; Starting generation 6/10, 40 members. [2024-01-08 02:23:22]</span></span>
<span><span class="co">#&gt;        light.Kw MET_wndspd MET_radswd outflow</span></span>
<span><span class="co">#&gt; mean     3.2610     0.8283     1.1830  0.6884</span></span>
<span><span class="co">#&gt; median   3.2580     0.7803     1.2180  0.5670</span></span>
<span><span class="co">#&gt; sd       0.9532     0.1546     0.1209  0.3851</span></span>
<span><span class="co">#&gt; Best fit: 2.1403 (sd: 106.18)</span></span>
<span><span class="co">#&gt; Survival rate: 1</span></span>
<span><span class="co">#&gt; Starting generation 7/10, 40 members. [2024-01-08 02:23:58]</span></span>
<span><span class="co">#&gt;        light.Kw MET_wndspd MET_radswd outflow</span></span>
<span><span class="co">#&gt; mean      4.065     0.9212    1.20400  0.6218</span></span>
<span><span class="co">#&gt; median    4.186     0.8745    1.21800  0.5514</span></span>
<span><span class="co">#&gt; sd        1.020     0.2035    0.05326  0.2705</span></span>
<span><span class="co">#&gt; Best fit: 2.1393 (sd: 76.069)</span></span>
<span><span class="co">#&gt; Survival rate: 1</span></span>
<span><span class="co">#&gt; Starting generation 8/10, 40 members. [2024-01-08 02:24:33]</span></span>
<span><span class="co">#&gt;        light.Kw MET_wndspd MET_radswd outflow</span></span>
<span><span class="co">#&gt; mean     3.9920     0.8316     1.1950  0.6679</span></span>
<span><span class="co">#&gt; median   3.9140     0.7964     1.2240  0.5465</span></span>
<span><span class="co">#&gt; sd       0.9833     0.1420     0.1048  0.4030</span></span>
<span><span class="co">#&gt; Best fit: 2.1356 (sd: 118.65)</span></span>
<span><span class="co">#&gt; Survival rate: 1</span></span>
<span><span class="co">#&gt; Starting generation 9/10, 40 members. [2024-01-08 02:25:08]</span></span>
<span><span class="co">#&gt;        light.Kw MET_wndspd MET_radswd outflow</span></span>
<span><span class="co">#&gt; mean      4.021     0.9204    1.20800  0.6374</span></span>
<span><span class="co">#&gt; median    4.178     0.9271    1.22300  0.5524</span></span>
<span><span class="co">#&gt; sd        1.278     0.1235    0.08341  0.2873</span></span>
<span><span class="co">#&gt; Best fit: 2.134 (sd: 84.127)</span></span>
<span><span class="co">#&gt; Survival rate: 1</span></span>
<span><span class="co">#&gt; Starting generation 10/10, 40 members. [2024-01-08 02:25:42]</span></span>
<span><span class="co">#&gt;        light.Kw MET_wndspd MET_radswd outflow</span></span>
<span><span class="co">#&gt; mean      4.499     0.9314    1.19600 0.58990</span></span>
<span><span class="co">#&gt; median    4.573     0.9027    1.21700 0.56740</span></span>
<span><span class="co">#&gt; sd        1.135     0.1157    0.07907 0.08665</span></span>
<span><span class="co">#&gt; Best fit: 2.1334 (sd: 0.055958)</span></span>
<span><span class="co">#&gt; Model has converged. Stopping simulation.</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="visualise-calibration-results">Visualise calibration results<a class="anchor" aria-label="anchor" href="#visualise-calibration-results"></a>
</h2>
<p>The calibrations results can be read in using the
<code>read_calib</code> function. This function takes the following
arguments:</p>
<ul>
<li>
<code>ctrl</code>: The control parameters used for the
calibration.</li>
<li>
<code>model</code>: The model used for the calibration.</li>
</ul>
<p>The <code>read_calib</code> function returns a dataframe with the
calibration results. The calibration results include the model,
generation, index (model run), parameter name, parameter value, fitness
value and the median fitness value for each generation.</p>
<p>These results can be visualised using the <code>plot_calib</code>
function. This function takes the following arguments:</p>
<ul>
<li>
<code>calib</code>: The calibration results as read in using the
<code>read_calib</code> function.</li>
<li>
<code>model</code>: The model used for the calibration.</li>
<li>
<code>ctrl</code>: The control parameters used for the
calibration.</li>
</ul>
<p>And returns a list of ggplot objects: a dotty plot, density plot and
convergence plot.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">calib_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_calib.html">read_calib</a></span><span class="op">(</span>ctrl <span class="op">=</span> <span class="va">ctrl</span>, model <span class="op">=</span> <span class="va">model</span>, path <span class="op">=</span> <span class="va">path</span><span class="op">)</span></span>
<span><span class="va">plist</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_calib.html">plot_calib</a></span><span class="op">(</span>calib <span class="op">=</span> <span class="va">calib_res</span>, model <span class="op">=</span> <span class="va">model</span>, </span>
<span>                      na_value <span class="op">=</span> <span class="va">ctrl</span><span class="op">$</span><span class="va">na_value</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="dotty-plot">Dotty plot<a class="anchor" aria-label="anchor" href="#dotty-plot"></a>
</h3>
<p>This can be used for comparing sensitivity across parameters. The
dotty plot shows the fitness value for each parameter value for each
generation. The fitness value is on the y-axis and the parameter value
is on the x-axis. It is faceted by the parameter name. The parameter
values are coloured by the generation. The best fitness value for each
generation is shown as a black line with a red dot.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plist</span><span class="op">$</span><span class="va">dotty</span></span></code></pre></div>
<p><img src="calibrate-aeme_files/figure-html/dotty-plot-1.png" width="768"></p>
</div>
<div class="section level3">
<h3 id="histogram-plot">Histogram plot<a class="anchor" aria-label="anchor" href="#histogram-plot"></a>
</h3>
<p>This is useful for comparing the distribution of parameter values
across generations. The histogram plot shows the frequency of the
parameter values for each generation. The parameter values are on the
x-axis and the density is on the y-axis. It is faceted by the parameter
name.</p>
<p>If a parameter is converging on a value, then the histogram will show
a peak around that value. If a parameter is not converging on a value,
then the histogram will show a flat distribution.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plist</span><span class="op">$</span><span class="va">hist</span></span></code></pre></div>
<p><img src="calibrate-aeme_files/figure-html/histogram-plot-1.png" width="768"></p>
</div>
<div class="section level3">
<h3 id="convergence-plot">Convergence plot<a class="anchor" aria-label="anchor" href="#convergence-plot"></a>
</h3>
<p>This is more generally used for assessing model convergence. The
convergence plot shows the values use over the iterations. The parameter
value is on the y-axis and the iteration is on the x-axis. It is faceted
by the parameter name. The parameter values are coloured by the
generation. The best fitness value for each generation is shown as a
solid horizontal black line.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plist</span><span class="op">$</span><span class="va">convergence</span></span></code></pre></div>
<p><img src="calibrate-aeme_files/figure-html/convergence-plot-1.png" width="768"></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Tadhg Moore, Chris McBride.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
