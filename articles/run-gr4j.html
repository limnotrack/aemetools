<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Run Hydrological models â€¢ aemetools</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Run Hydrological models">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">aemetools</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/access-geospatial.html">Access geospatial data</a></li>
    <li><a class="dropdown-item" href="../articles/calibrate-aeme.html">Calibrate AEME</a></li>
    <li><a class="dropdown-item" href="../articles/download-era5.html">Download ERA5 data</a></li>
    <li><a class="dropdown-item" href="../articles/run-gr4j.html">Run Hydrological models</a></li>
    <li><a class="dropdown-item" href="../articles/sensitivity-analysis.html">Sensitivity Analysis</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/limnotrack/aemetools/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Run Hydrological models</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/limnotrack/aemetools/blob/main/vignettes/run-gr4j.Rmd" class="external-link"><code>vignettes/run-gr4j.Rmd</code></a></small>
      <div class="d-none name"><code>run-gr4j.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://limnotrack.github.io/aemetools/">aemetools</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: replacing previous import 'AEME::time' by 'terra::time' when loading</span></span>
<span><span class="co">#&gt; 'aemetools'</span></span></code></pre></div>
<div class="section level3">
<h3 id="hydrological-modelling---run-gr4j-model">Hydrological modelling - Run GR4J model<a class="anchor" aria-label="anchor" href="#hydrological-modelling---run-gr4j-model"></a>
</h3>
<p>Here is simple example set up for one of the lake inflows into Lake
Rotorua. First, the input for the model are generated using the stream
ID (nzsegment), and spatial features (sf objects) of the reaches, lake
and catchment (including sub-catchments), observed discharge (if
available) meteorological data (air temperature and precipitation). It
recursively creates an upstream network using the nzsegment, then
combines the subcatchments of all the upstream reaches
(<code><a href="https://r-spatial.github.io/sf/reference/geos_combine.html" class="external-link">sf::st_union()</a></code>) to calculate the area of the
catchment.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lat</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">38.079</span></span>
<span><span class="va">data_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/hydro/"</span>, package <span class="op">=</span> <span class="st">"aemetools"</span><span class="op">)</span></span>
<span><span class="va">lake</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/serialize.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">data_dir</span>, <span class="st">"lake.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">reaches</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/serialize.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">data_dir</span>, <span class="st">"reaches.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">catchments</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/serialize.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">data_dir</span>, <span class="st">"catchments.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">met</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/serialize.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">data_dir</span>, <span class="st">"met.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">obs_flow</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/serialize.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">data_dir</span>, <span class="st">"obs_flow.rds"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">FUN_MOD</span> <span class="op">&lt;-</span> <span class="fu">airGR</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/airGR/man/RunModel_GR4J.html" class="external-link">RunModel_GR4J</a></span></span>
<span><span class="va">id</span> <span class="op">&lt;-</span> <span class="fl">4087861</span> <span class="co"># nzsegment</span></span>
<span></span>
<span><span class="va">inputs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_GR_inputs.html">make_GR_inputs</a></span><span class="op">(</span>id <span class="op">=</span> <span class="va">id</span>, reaches <span class="op">=</span> <span class="va">reaches</span>, lake <span class="op">=</span> <span class="va">lake</span>,</span>
<span>                         catchments <span class="op">=</span> <span class="va">catchments</span>, obs_flow <span class="op">=</span> <span class="va">obs_flow</span>, met <span class="op">=</span> <span class="va">met</span>,</span>
<span>                         lat <span class="op">=</span> <span class="va">lat</span>, FUN_MOD <span class="op">=</span> <span class="va">FUN_MOD</span>,</span>
<span>                         plot <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="run-gr4j_files/figure-html/make-gr4j-inputs-1.png" width="700"></p>
<p>Within the <code>airGR</code> package, there are calibration
algorithms which allows you to calibrate the hydrological model if
discharge data for the reach is available. The calibrated parameters can
be passed to the <code>run_GR</code> function to run the selected
model.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' airGR uses indices to run the model, so first we split our observed data in </span></span>
<span><span class="co">#' half (0.5) for calibration and validation periods based on when the </span></span>
<span><span class="co">#' observation data starts (which is provided in `inputs$data$start`).</span></span>
<span><span class="va">idx_spl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">inputs</span><span class="op">$</span><span class="va">data</span><span class="op">[</span><span class="va">inputs</span><span class="op">$</span><span class="va">start</span><span class="op">:</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">inputs</span><span class="op">$</span><span class="va">data</span><span class="op">)</span>, <span class="op">]</span><span class="op">)</span></span>
<span>                 <span class="op">*</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="co">#' Use a model warmup period as everything before when the observations start.</span></span>
<span><span class="va">warmup</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">inputs</span><span class="op">$</span><span class="va">start</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set the indices for the calibration period</span></span>
<span><span class="va">cal_idx</span> <span class="op">&lt;-</span> <span class="va">inputs</span><span class="op">$</span><span class="va">start</span><span class="op">:</span><span class="op">(</span><span class="va">idx_spl</span> <span class="op">+</span> <span class="va">inputs</span><span class="op">$</span><span class="va">start</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run the calibration and assign the output</span></span>
<span><span class="va">calib</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calib_GR.html">calib_GR</a></span><span class="op">(</span>inputs <span class="op">=</span> <span class="va">inputs</span>, warmup <span class="op">=</span> <span class="va">warmup</span>, run_index <span class="op">=</span> <span class="va">cal_idx</span><span class="op">)</span></span>
<span><span class="co">#&gt; Grid-Screening in progress (0% 20% 40% 60% 80% 100%)</span></span>
<span><span class="co">#&gt;   Screening completed (81 runs)</span></span>
<span><span class="co">#&gt;       Param =  432.681,   -2.376,   83.096,    2.384</span></span>
<span><span class="co">#&gt;       Crit. NSE[Q]       = -12.8326</span></span>
<span><span class="co">#&gt; Steepest-descent local search in progress</span></span>
<span><span class="co">#&gt;   Calibration completed (30 iterations, 289 runs)</span></span>
<span><span class="co">#&gt;       Param = 21807.299,   -9.151,  104.585,    2.003</span></span>
<span><span class="co">#&gt;       Crit. NSE[Q]       = 0.4836</span></span>
<span></span>
<span><span class="co"># Extract the calibrated parameters</span></span>
<span><span class="va">param</span> <span class="op">&lt;-</span> <span class="va">calib</span><span class="op">$</span><span class="va">ParamFinalR</span></span>
<span></span>
<span><span class="co"># Run the model</span></span>
<span><span class="va">output</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_GR.html">run_GR</a></span><span class="op">(</span>inputs <span class="op">=</span> <span class="va">inputs</span>, param <span class="op">=</span> <span class="va">param</span>,</span>
<span>                 warmup <span class="op">=</span> <span class="va">warmup</span>, run_index <span class="op">=</span> <span class="va">cal_idx</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot the output</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">output</span>, Qobs <span class="op">=</span> <span class="va">inputs</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">Qmm</span><span class="op">[</span><span class="va">cal_idx</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="run-gr4j_files/figure-html/run-gr4j-1.png" width="768"></p>
</div>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Tadhg Moore, Chris McBride.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
