<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="aemetools">
<title>Calibration strategies • aemetools</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Calibration strategies">
<meta property="og:description" content="aemetools">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">aemetools</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/calibrate-aeme.html">Calibrate AEME</a>
    <a class="dropdown-item" href="../articles/calibration-strategies.html">Calibration strategies</a>
    <a class="dropdown-item" href="../articles/download-era5.html">Download ERA5 data</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Calibration strategies</h1>
            
      
      
      <div class="d-none name"><code>calibration-strategies.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="calibration-strategies-for-aquatic-ecosystem-models">Calibration strategies for Aquatic Ecosystem Models<a class="anchor" aria-label="anchor" href="#calibration-strategies-for-aquatic-ecosystem-models"></a>
</h2>
<p>Calibrating aquatic ecosystem models is a difficult task. The models
are complex, and the data are often sparse and noisy.</p>
<p>Optimising a model is a process of finding the best set of
parameters. This can potentiall be across a wide range of response
variables. For example, it can include optimisations for water
temperature, lake level, and chlorophyll-a. Therefore, it is important
to have a strategy for calibrating the models under such scenarions.</p>
<p>This vignette will demonstrate how to calibrate the AEME models using
different strategies.</p>
<div class="section level3">
<h3 id="strategy-1-calibrate-lake-level">Strategy #1: Calibrate lake level<a class="anchor" aria-label="anchor" href="#strategy-1-calibrate-lake-level"></a>
</h3>
<p>When running long-term simulations for lakes, it is critically
important that the lake water balance is fully resolved. This is because
the lake level will be a key driver for many of the processes in the
lake. For example, the lake level will determine the surface area of the
lake, which will determine the amount of incoming shortwave radiation
which affects evaporation the overall heat exchane in the lake. It will
also determine the volume of the lake, which will determine the amount
of nutrients in the lake.</p>
<p>Here we demonstrate how to calibrate the lake level for the AEME-GOTM
model. It is important to remember that if there is no observed lake
level present in the <code>aeme</code> object, then the lake level will
be estimated using supplied rainfall, inflows (if present), outflows (if
present), and calculated evaporation using air temperature and wind
speed and lake surface area. When this cal</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load libraries</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://expert-guide-29ve1vw.pages.github.io/" class="external-link">AEME</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'AEME'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     time</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://studious-enigma-z736ppg.pages.github.io/" class="external-link">aemetools</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a temporary directory</span></span>
<span><span class="va">tmpdir</span> <span class="op">&lt;-</span> <span class="st">"calib-test"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">tmpdir</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">aeme_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata/lake/"</span>, package <span class="op">=</span> <span class="st">"AEME"</span><span class="op">)</span></span>
<span><span class="co"># Copy files from package into tempdir</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.copy</a></span><span class="op">(</span><span class="va">aeme_dir</span>, <span class="va">tmpdir</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="va">path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">tmpdir</span>, <span class="st">"lake"</span><span class="op">)</span></span>
<span><span class="va">aeme_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/AEME/man/yaml_to_aeme.html" class="external-link">yaml_to_aeme</a></span><span class="op">(</span>path <span class="op">=</span> <span class="va">path</span>, <span class="st">"aeme.yaml"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Linking to GEOS 3.11.2, GDAL 3.6.2, PROJ 9.2.0; sf_use_s2() is FALSE</span></span>
<span><span class="co">#&gt; Warning in aeme_constructor(lake = yaml$lake, catchment = yaml$catchment, : Lake area [152343 m2] is different to the area calculated from the lake</span></span>
<span><span class="co">#&gt; shape [152433.09 m2].</span></span>
<span></span>
<span><span class="co"># Remove observations and outflow from example data</span></span>
<span><span class="va">obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/AEME/man/observations.html" class="external-link">observations</a></span><span class="op">(</span><span class="va">aeme_data</span><span class="op">)</span></span>
<span><span class="va">obs</span><span class="op">$</span><span class="va">lake</span> <span class="op">&lt;-</span> <span class="cn">NULL</span> <span class="co"># Remove all observations except lake level</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/AEME/man/observations.html" class="external-link">observations</a></span><span class="op">(</span><span class="va">aeme_data</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">obs</span></span>
<span><span class="va">outf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/AEME/man/outflows.html" class="external-link">outflows</a></span><span class="op">(</span><span class="va">aeme_data</span><span class="op">)</span></span>
<span><span class="va">outf</span><span class="op">$</span><span class="va">data</span> <span class="op">&lt;-</span> <span class="cn">NULL</span> <span class="co"># Remove all outflows</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/AEME/man/outflows.html" class="external-link">outflows</a></span><span class="op">(</span><span class="va">aeme_data</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">outf</span></span>
<span></span>
<span><span class="va">mod_ctrls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">path</span>, <span class="st">"model_controls.csv"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">inf_factor</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"dy_cd"</span> <span class="op">=</span> <span class="fl">1</span>, <span class="st">"glm_aed"</span> <span class="op">=</span> <span class="fl">1</span>, <span class="st">"gotm_wet"</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">outf_factor</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"dy_cd"</span> <span class="op">=</span> <span class="fl">1</span>, <span class="st">"glm_aed"</span> <span class="op">=</span> <span class="fl">1</span>, <span class="st">"gotm_wet"</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"gotm_wet"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Build the ensemble - this includes lake level estimation</span></span>
<span><span class="va">aeme_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/AEME/man/build_ensemble.html" class="external-link">build_ensemble</a></span><span class="op">(</span>path <span class="op">=</span> <span class="va">path</span>, aeme_data <span class="op">=</span> <span class="va">aeme_data</span>,</span>
<span>                            model <span class="op">=</span> <span class="va">model</span>, mod_ctrls <span class="op">=</span> <span class="va">mod_ctrls</span>,</span>
<span>                            inf_factor <span class="op">=</span> <span class="va">inf_factor</span>, ext_elev <span class="op">=</span> <span class="fl">5</span>,</span>
<span>                            use_bgc <span class="op">=</span> <span class="cn">FALSE</span>, use_lw <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Building simulation for Wainamu [2023-11-05 22:13:03.146985]</span></span>
<span><span class="co">#&gt; Using observed water level</span></span>
<span><span class="co">#&gt; Estimating temperature using Stefan &amp; Preud'homme (2007)...</span></span>
<span><span class="co">#&gt; Warning in build_ensemble(path = path, aeme_data = aeme_data, model = model, : Outflow data are not present. This function will generate an estimated</span></span>
<span><span class="co">#&gt; outflow with a calculated water balance using lake level, inflow data</span></span>
<span><span class="co">#&gt; (if present) and estimated evaporation rates.</span></span>
<span><span class="co">#&gt; Observed lake level is present. Updating initial lake model depth...</span></span>
<span><span class="co">#&gt; Building GOTM-WET for lake wainamu</span></span>
<span><span class="co">#&gt; Copied all GOTM configuration files</span></span></code></pre></div>
<p>Let’s look at the lake level calculated and the estimated outflows
(wbal) for the lake.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">aeme_data</span>, <span class="st">"observations"</span><span class="op">)</span></span></code></pre></div>
<p><img src="calibration-strategies_files/figure-html/plot-level-1.png" width="768"></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">aeme_data</span>, <span class="st">"outflows"</span><span class="op">)</span></span></code></pre></div>
<p><img src="calibration-strategies_files/figure-html/plot-level-2.png" width="768"></p>
<p>Now we will run the model and plot the model outputs against the
observations.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">aeme_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/AEME/man/run_aeme.html" class="external-link">run_aeme</a></span><span class="op">(</span>aeme_data <span class="op">=</span> <span class="va">aeme_data</span>, model <span class="op">=</span> <span class="va">model</span>,</span>
<span>                      verbose <span class="op">=</span> <span class="cn">FALSE</span>, mod_ctrls <span class="op">=</span> <span class="va">mod_ctrls</span>,</span>
<span>                      path <span class="op">=</span> <span class="va">path</span><span class="op">)</span></span>
<span><span class="co">#&gt; Running models... (Have you tried parallelizing?) [2023-11-05 22:13:04.709763]</span></span>
<span><span class="co">#&gt; GOTM-WET run successful! [2023-11-05 22:13:05.294482]</span></span>
<span><span class="co">#&gt; Model run complete![2023-11-05 22:13:05.295678]</span></span>
<span><span class="co">#&gt; Retrieving and formatting temp for model gotm_wet</span></span>
<span><span class="co">#&gt; Retrieving and formatting salt for model gotm_wet</span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/AEME/man/plot_output.html" class="external-link">plot_output</a></span><span class="op">(</span>aeme_data <span class="op">=</span> <span class="va">aeme_data</span>, model <span class="op">=</span> <span class="va">model</span>, var_sim <span class="op">=</span> <span class="st">"HYD_wlev"</span>,</span>
<span>                  print_plots <span class="op">=</span> <span class="cn">FALSE</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">12.8</span>, <span class="fl">14</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_size_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Obs"</span> <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Uncalibrated model"</span><span class="op">)</span></span>
<span><span class="va">p1</span></span></code></pre></div>
<p><img src="calibration-strategies_files/figure-html/strategy1-run-plot-1.png" width="768"></p>
<p>Although, this is a short time period and ideally a longer time
period would be used. A common issue for lakes is to be either gaining
too much water or running out of water. This can be caused by a number
of factors:</p>
<ul>
<li>Missing or inaccurate inflow/outflow data</li>
<li>Inaccurate measurements of precipitation</li>
<li>Missing or inaccurate lake level data</li>
<li>Inaccurate estimations of lake volume</li>
<li>Inaccurate estimations of lake evaporation</li>
</ul>
<p>Generally, the most common cause is missing or inaccurate outflow
data. For this reason, we assume that there is large uncertainty in the
outflow data and therefore we will calibrate a scaling factor for the
outflow data.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"aeme_parameters"</span>, package <span class="op">=</span> <span class="st">"aemetools"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">param</span> <span class="op">&lt;-</span> <span class="va">aeme_parameters</span><span class="op">[</span><span class="va">aeme_parameters</span><span class="op">$</span><span class="va">model</span> <span class="op">==</span> <span class="va">model</span>, <span class="op">]</span></span>
<span><span class="va">param</span></span>
<span><span class="co">#&gt;      model      file                               name       value   min</span></span>
<span><span class="co">#&gt; 5 gotm_wet gotm.yaml        turbulence/turb_param/k_min 0.000000632 1e-09</span></span>
<span><span class="co">#&gt; 6 gotm_wet gotm.yaml light_extinction/g2/constant_value 0.200000000 5e-02</span></span>
<span><span class="co">#&gt; 7 gotm_wet       met                         MET_wndspd 1.069170000 7e-01</span></span>
<span><span class="co">#&gt; 8 gotm_wet       met                         MET_radswd 1.173400000 7e-01</span></span>
<span><span class="co">#&gt; 9 gotm_wet       wdr                            outflow 1.000000000 5e-01</span></span>
<span><span class="co">#&gt;       max</span></span>
<span><span class="co">#&gt; 5 0.00001</span></span>
<span><span class="co">#&gt; 6 2.70000</span></span>
<span><span class="co">#&gt; 7 1.30000</span></span>
<span><span class="co">#&gt; 8 1.30000</span></span>
<span><span class="co">#&gt; 9 2.50000</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Function to calculate fitness</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">O</span>, <span class="va">P</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="op">-</span><span class="fl">1</span> <span class="op">*</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">O</span>, y <span class="op">=</span> <span class="va">P</span>, method <span class="op">=</span> <span class="st">"pearson"</span><span class="op">)</span> <span class="op">-</span></span>
<span>          <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">O</span> <span class="op">-</span> <span class="va">P</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">O</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">O</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">ctrl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>VTR <span class="op">=</span> <span class="op">-</span><span class="cn">Inf</span>, NP <span class="op">=</span> <span class="fl">20</span>, itermax <span class="op">=</span> <span class="fl">400</span>, reltol <span class="op">=</span> <span class="fl">0.07</span>, p <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>             mutate <span class="op">=</span> <span class="fl">0.1</span>, parallel <span class="op">=</span> <span class="cn">TRUE</span>, out_file <span class="op">=</span> <span class="st">"results.csv"</span>,</span>
<span>             na_value <span class="op">=</span> <span class="fl">999</span><span class="op">)</span></span>
<span></span>
<span><span class="va">vars_sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"HYD_wlev"</span><span class="op">)</span></span>
<span><span class="va">weights</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"HYD_wlev"</span> <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calibrate AEME model</span></span>
<span><span class="va">ctrl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calib_aeme.html">calib_aeme</a></span><span class="op">(</span>aeme_data <span class="op">=</span> <span class="va">aeme_data</span>, path <span class="op">=</span> <span class="va">path</span>,</span>
<span>                   param <span class="op">=</span> <span class="va">param</span>, model <span class="op">=</span> <span class="va">model</span>,</span>
<span>                   mod_ctrls <span class="op">=</span> <span class="va">mod_ctrls</span>, FUN <span class="op">=</span> <span class="va">fit</span>, ctrl <span class="op">=</span> <span class="va">ctrl</span>,</span>
<span>                   vars_sim <span class="op">=</span> <span class="va">vars_sim</span>, weights <span class="op">=</span> <span class="va">weights</span><span class="op">)</span></span>
<span></span>
<span><span class="va">calib_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_calib.html">read_calib</a></span><span class="op">(</span>ctrl <span class="op">=</span> <span class="va">ctrl</span>, model <span class="op">=</span> <span class="va">model</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">testthat</span><span class="fu">::</span><span class="fu"><a href="https://testthat.r-lib.org/reference/logical-expectations.html" class="external-link">expect_true</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">is.data.frame</a></span><span class="op">(</span><span class="va">calib_res</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plist</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_calib.html">plot_calib</a></span><span class="op">(</span>calib <span class="op">=</span> <span class="va">calib_res</span>, model <span class="op">=</span> <span class="va">model</span>,</span>
<span>                    na_value <span class="op">=</span> <span class="va">ctrl</span><span class="op">$</span><span class="va">na_value</span><span class="op">)</span></span>
<span><span class="va">plist</span><span class="op">$</span><span class="va">dotty</span></span>
<span><span class="co">#&gt; Warning: Removed 455 rows containing missing values (`geom_point()`).</span></span></code></pre></div>
<p><img src="calibration-strategies_files/figure-html/strategy1-calib-1.png" width="768"></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># library(patchwork)</span></span>
<span><span class="co"># wrap_plots(plist, guides = "collect", design = "AB</span></span>
<span><span class="co">#            CC")</span></span></code></pre></div>
<p>Extract the calibrated parameters and run the model again.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Extract the calibrated parameters</span></span>
<span><span class="va">best_pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_param.html">get_param</a></span><span class="op">(</span>calib <span class="op">=</span> <span class="va">calib_res</span>, model <span class="op">=</span> <span class="va">model</span>, </span>
<span>                       na_value <span class="op">=</span> <span class="va">ctrl</span><span class="op">$</span><span class="va">na_value</span>, best <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">param</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/update_param.html">update_param</a></span><span class="op">(</span>param <span class="op">=</span> <span class="va">param</span>, best_pars <span class="op">=</span> <span class="va">best_pars</span><span class="op">)</span></span>
<span></span>
<span><span class="va">aeme_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_aeme_param.html">run_aeme_param</a></span><span class="op">(</span>aeme_data <span class="op">=</span> <span class="va">aeme_data</span>, model <span class="op">=</span> <span class="va">model</span>, </span>
<span>                            mod_ctrls <span class="op">=</span> <span class="va">mod_ctrls</span>, path <span class="op">=</span> <span class="va">path</span>, param <span class="op">=</span> <span class="va">param</span>,</span>
<span>                            return_aeme <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Running models... (Have you tried parallelizing?) [2023-11-05 22:18:23.854444]</span></span>
<span><span class="co">#&gt; GOTM-WET run successful! [2023-11-05 22:18:24.43544]</span></span>
<span><span class="co">#&gt; Model run complete![2023-11-05 22:18:24.43623]</span></span>
<span><span class="co">#&gt; Retrieving and formatting temp for model gotm_wet</span></span>
<span><span class="co">#&gt; Retrieving and formatting salt for model gotm_wet</span></span>
<span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/AEME/man/plot_output.html" class="external-link">plot_output</a></span><span class="op">(</span>aeme_data <span class="op">=</span> <span class="va">aeme_data</span>, model <span class="op">=</span> <span class="va">model</span>, var_sim <span class="op">=</span> <span class="st">"HYD_wlev"</span>,</span>
<span>                  print_plots <span class="op">=</span> <span class="cn">FALSE</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">12.8</span>, <span class="fl">14</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_size_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Obs"</span> <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Calibrated model"</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span></span>
<span><span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span></span></code></pre></div>
<p><img src="calibration-strategies_files/figure-html/strategy1-run-calib-plot-1.png" width="768"></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Tadhg Moore, Chris McBride.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
